---
title: js是如何执行的
---

# js 是如何执行的

![](https://tva1.sinaimg.cn/large/008eGmZEly1gppfwip6vwj30kc0eedh7.jpg)

## 编译时机

编译执行: 它首先将源代码转换为中间代码，编译再将中间代码编译成机器代码（二进制），再由机器运行机器码。

- 特点： 运行前编译，启动慢，执行快

解释执行: 同样，它首先将源代码转换为中间代码，之后直接使用解释
器解释执行中间代码，再由解释器对中间代码进行解释运行。

- 特点： 运行时编译，启动快，执行慢

`编译时机`是 js 和其他编译型语言最大的区别，编译型语言编译后全量转为机器语言，可以直接执行。而 js 则需要运行时来解释，这个解释器被称为 js 引擎。

## js 引擎

js 早期运行在浏览器环境，然而厂商们各自为政，为了掌控自家的浏览器，实现了不同的 js 引擎：

- V8 --> 开源，用于 Chrome 浏览器、NodeJS
- SpiderMonkey --> 用于 Firfox 浏览器
- JavaScriptCore --> 开源，Safari 浏览器
- Chakra --> IE and Edge

这些引擎的共同特点就是实现 ECMAScript 定义的语言标准，但是某些 api 并不一致，所以以前实现个简单功能，往往需要写很长的面条代码，来适配不同的浏览器环境，这就是前端需要处理的部分兼容性问题。

## V8

说到 js 引擎，Google V8 就是其中的王者。V8 命名来源于 8 缸发动机。在发动机界，V8 代表着高排量，大马力，高性能。同样，在 js 界，V8 一直是高性能的代表，它使用了多种手段提升执行速度。

## JIT（Just In Time）技术

从上文我们已经了解编译执行和解释执行的优缺点，V8 在这两种模式间找了个平衡点，混合使用这两种技术，这就是 JIT。先看一下 V8 完整执行流程：

![](https://tva1.sinaimg.cn/large/008i3skNly1gptb706qskj30vq0gsq5l.jpg)

1. 启动时初始化执行环境
2. 解析器生成 AST 和作用域
3. 生成中间代码-字节码
4. 解释器-解释执行字节码，同时监控重复执行的热点代码，编译为优化的二进制代码，后续无需解释，直接执行

## 简单执行实例

下面我们就用最简单的代码，走一遍实际的流程。代码如下：

```js
var a = 2;
```

我们知道，这段代码会经过解析器生成 AST，那么生成的 AST 是什么样呢?我们使用 V8 的调试工具 D8 来查看一下

```bash
d8 --print-ast v8-test.js
```

输出如下：

```js
--- AST ---
FUNC at 0
. KIND 0
. LITERAL ID 0
. SUSPEND COUNT 0
. NAME ""
. INFERRED NAME ""
. DECLS
. . VARIABLE (0x7fb02a830498) (mode = VAR, assigned = true) "a"
. BLOCK NOCOMPLETIONS at -1
. . EXPRESSION STATEMENT at 8
. . . INIT at 8
. . . . VAR PROXY unallocated (0x7fb02a830498) (mode = VAR, assigned = true) "a"
. . . . LITERAL 2
```

生产 AST 的同时还生成了作用域，作用域到底是什么样呢？

```js
d8 --print-scopes v8-test.js
```

```js
Global scope:
global { // (0x7fb8dd84bc48) (0, 84)
  // will be compiled
  // 1 stack slots
  // temporary vars:
  TEMPORARY .result;  // (0x7fb8dd84bfa0) local[0]
  // local vars:
  VAR a;  // (0x7fb8dd84be98)
}
```

有了 AST 和作用域之后就可以生成字节码了

```js
d8 --print-bytecode v8-test.js
```

```js
[generated bytecode for function:  (0x14e80824fded <SharedFunctionInfo>)]
Parameter count 1
Register count 3
Frame size 24
         0x14e80824fe5a @    0 : 12 00             LdaConstant [0]
         0x14e80824fe5c @    2 : 26 fa             Star r1
         0x14e80824fe5e @    4 : 27 fe f9          Mov <closure>, r2
         0x14e80824fe61 @    7 : 61 37 01 fa 02    CallRuntime [DeclareGlobals], r1-r2
         0x14e80824fe66 @   12 : 0c 02             LdaSmi [2]
         0x14e80824fe68 @   14 : 15 01 00          StaGlobal [1], [0]
         0x14e80824fe6b @   17 : 0d                LdaUndefined
         0x14e80824fe6c @   18 : aa                Return
Constant pool (size = 2)
0x14e80824fe29: [FixedArray] in OldSpace
 - map: 0x14e8080404b1 <Map>
 - length: 2
           0: 0x14e80824fe15 <FixedArray[1]>
           1: 0x14e80808add1 <String[#1]: a>
Handler Table (size = 0)
Source Position Table (size = 0)
```

## for 循环揭秘

一直好奇 for 循环中，使用 let 时变量如何处理的，我们来看下生成的 AST

### AST

var

```js
[generating bytecode for function: ]
--- AST ---
FUNC at 0
. KIND 0
. LITERAL ID 0
. SUSPEND COUNT 0
. NAME ""
. INFERRED NAME ""
. DECLS
. . VARIABLE (0x7fd1e78192a0) (mode = VAR, assigned = true) "i"
. BLOCK at -1
. . EXPRESSION STATEMENT at -1
. . . ASSIGN at -1
. . . . VAR PROXY local[0] (0x7fd1e78196a0) (mode = TEMPORARY, assigned = true) ".result"
. . . . LITERAL undefined
. . FOR at 58
. . . INIT at -1
. . . . BLOCK NOCOMPLETIONS at -1
. . . . . EXPRESSION STATEMENT at 71
. . . . . . INIT at 71
. . . . . . . VAR PROXY unallocated (0x7fd1e78192a0) (mode = VAR, assigned = true) "i"
. . . . . . . LITERAL 0
. . . COND at 76
. . . . LT at 76
. . . . . VAR PROXY unallocated (0x7fd1e78192a0) (mode = VAR, assigned = true) "i"
. . . . . LITERAL 3
. . . BODY at -1
. . . . BLOCK at -1
. . . . . EXPRESSION STATEMENT at 90
. . . . . . ASSIGN at -1
. . . . . . . VAR PROXY local[0] (0x7fd1e78196a0) (mode = TEMPORARY, assigned = true) ".result"
. . . . . . . CALL
. . . . . . . . PROPERTY at 98
. . . . . . . . . VAR PROXY unallocated (0x7fd1e78197e0) (mode = DYNAMIC_GLOBAL, assigned = false) "console"
. . . . . . . . . NAME log
. . . . . . . . VAR PROXY unallocated (0x7fd1e78192a0) (mode = VAR, assigned = true) "i"
. . . NEXT at 82
. . . . EXPRESSION STATEMENT at 82
. . . . . POST INC at 82
. . . . . . VAR PROXY unallocated (0x7fd1e78192a0) (mode = VAR, assigned = true) "i"
. RETURN at -1
. . VAR PROXY local[0] (0x7fd1e78196a0) (mode = TEMPORARY, assigned = true) ".result"
```

let

```js
[generating bytecode for function: ]
--- AST ---
FUNC at 0
. KIND 0
. LITERAL ID 0
. SUSPEND COUNT 0
. NAME ""
. INFERRED NAME ""
. BLOCK at -1
. . BLOCK NOCOMPLETIONS at -1
. . . EXPRESSION STATEMENT at 13
. . . . INIT at 13
. . . . . VAR PROXY local[1] (0x7fef27811940) (mode = LET, assigned = true) "i"
. . . . . LITERAL 0
. . BLOCK at -1
. . . EXPRESSION STATEMENT at -1
. . . . ASSIGN at -1
. . . . . VAR PROXY local[0] (0x7fef27811ec0) (mode = TEMPORARY, assigned = true) ".result"
. . . . . LITERAL undefined
. . . FOR at 0
. . . . COND at 18
. . . . . LT at 18
. . . . . . VAR PROXY local[1] (0x7fef27811940) (mode = LET, assigned = true) "i"
. . . . . . LITERAL 3
. . . . BODY at -1
. . . . . BLOCK at -1
. . . . . . EXPRESSION STATEMENT at 32
. . . . . . . ASSIGN at -1
. . . . . . . . VAR PROXY local[0] (0x7fef27811ec0) (mode = TEMPORARY, assigned = true) ".result"
. . . . . . . . CALL
. . . . . . . . . PROPERTY at 40
. . . . . . . . . . VAR PROXY unallocated (0x7fef27812000) (mode = DYNAMIC_GLOBAL, assigned = false) "console"
. . . . . . . . . . NAME log
. . . . . . . . . VAR PROXY local[1] (0x7fef27811940) (mode = LET, assigned = true) "i"
. . . . NEXT at 24
. . . . . EXPRESSION STATEMENT at 24
. . . . . . POST INC at 24
. . . . . . . VAR PROXY local[1] (0x7fef27811940) (mode = LET, assigned = true) "i"
. RETURN at -1
. . VAR PROXY local[0] (0x7fef27811ec0) (mode = TEMPORARY, assigned = true) ".result"
```

### 字节码

var

```js
[generated bytecode for function:  (0x20ef0824fded <SharedFunctionInfo>)]
Parameter count 1
Register count 4
Frame size 32
         0x20ef0824fe62 @    0 : 12 00             LdaConstant [0]
         0x20ef0824fe64 @    2 : 26 fa             Star r1
         0x20ef0824fe66 @    4 : 27 fe f9          Mov <closure>, r2
         0x20ef0824fe69 @    7 : 61 37 01 fa 02    CallRuntime [DeclareGlobals], r1-r2
         0x20ef0824fe6e @   12 : 0d                LdaUndefined
         0x20ef0824fe6f @   13 : 26 fb             Star r0
         0x20ef0824fe71 @   15 : 0b                LdaZero
         0x20ef0824fe72 @   16 : 15 01 00          StaGlobal [1], [0]
         0x20ef0824fe75 @   19 : 13 01 02          LdaGlobal [1], [2]
         0x20ef0824fe78 @   22 : 26 fa             Star r1
         0x20ef0824fe7a @   24 : 0c 03             LdaSmi [3]
         0x20ef0824fe7c @   26 : 69 fa 04          TestLessThan r1, [4]
         0x20ef0824fe7f @   29 : 9a 24             JumpIfFalse [36] (0x20ef0824fea3 @ 65)
         0x20ef0824fe81 @   31 : 13 02 05          LdaGlobal [2], [5]
         0x20ef0824fe84 @   34 : 26 f9             Star r2
         0x20ef0824fe86 @   36 : 28 f9 03 07       LdaNamedProperty r2, [3], [7]
         0x20ef0824fe8a @   40 : 26 fa             Star r1
         0x20ef0824fe8c @   42 : 13 01 02          LdaGlobal [1], [2]
         0x20ef0824fe8f @   45 : 26 f8             Star r3
         0x20ef0824fe91 @   47 : 59 fa f9 f8 09    CallProperty1 r1, r2, r3, [9]
         0x20ef0824fe96 @   52 : 26 fb             Star r0
         0x20ef0824fe98 @   54 : 13 01 02          LdaGlobal [1], [2]
         0x20ef0824fe9b @   57 : 4c 0b             Inc [11]
         0x20ef0824fe9d @   59 : 15 01 00          StaGlobal [1], [0]
         0x20ef0824fea0 @   62 : 8a 2b 00          JumpLoop [43], [0] (0x20ef0824fe75 @ 19)
         0x20ef0824fea3 @   65 : 25 fb             Ldar r0
         0x20ef0824fea5 @   67 : aa                Return
Constant pool (size = 4)
0x20ef0824fe29: [FixedArray] in OldSpace
 - map: 0x20ef080404b1 <Map>
 - length: 4
           0: 0x20ef0824fe15 <FixedArray[1]>
           1: 0x20ef0808b499 <String[#1]: i>
           2: 0x20ef081c696d <String[#7]: console>
           3: 0x20ef081c69e1 <String[#3]: log>
Handler Table (size = 0)
Source Position Table (size = 0)
```

let

```js
[generated bytecode for function:  (0x30380824fded <SharedFunctionInfo>)]
Parameter count 1
Register count 4
Frame size 32
         0x30380824fe4e @    0 : 0b                LdaZero
         0x30380824fe4f @    1 : 26 fa             Star r1
         0x30380824fe51 @    3 : 0d                LdaUndefined
         0x30380824fe52 @    4 : 26 fb             Star r0
         0x30380824fe54 @    6 : 0c 03             LdaSmi [3]
         0x30380824fe56 @    8 : 69 fa 00          TestLessThan r1, [0]
         0x30380824fe59 @   11 : 9a 1d             JumpIfFalse [29] (0x30380824fe76 @ 40)
         0x30380824fe5b @   13 : 13 00 01          LdaGlobal [0], [1]
         0x30380824fe5e @   16 : 26 f8             Star r3
         0x30380824fe60 @   18 : 28 f8 01 03       LdaNamedProperty r3, [1], [3]
         0x30380824fe64 @   22 : 26 f9             Star r2
         0x30380824fe66 @   24 : 59 f9 f8 fa 05    CallProperty1 r2, r3, r1, [5]
         0x30380824fe6b @   29 : 26 fb             Star r0
         0x30380824fe6d @   31 : 25 fa             Ldar r1
         0x30380824fe6f @   33 : 4c 07             Inc [7]
         0x30380824fe71 @   35 : 26 fa             Star r1
         0x30380824fe73 @   37 : 8a 1f 00          JumpLoop [31], [0] (0x30380824fe54 @ 6)
         0x30380824fe76 @   40 : 25 fb             Ldar r0
         0x30380824fe78 @   42 : aa                Return
Constant pool (size = 2)
0x30380824fe1d: [FixedArray] in OldSpace
 - map: 0x3038080404b1 <Map>
 - length: 2
           0: 0x3038081c696d <String[#7]: console>
           1: 0x3038081c69e1 <String[#3]: log>
Handler Table (size = 0)
Source Position Table (size = 0)
```
